## 一、以太坊私链搭建与Java发布智能合约

### 1、以太坊geth搭建自己的私链（Windows）

1. 下载官网geth并安装（https://github.com/ethereum/go-ethereum/releases/tag/v1.4.11）

2. 在geth的安装目录下放置初始化创世块文件genesis.json，文件内容如下

   ```json
   {
       "config": {
           "chainId": 10,//区块链的id，公有链为1
           "homesteadBlock": 0,
           "eip155Block": 0,
           "eip158Block": 0
       },
       //用来提前设置账号的以太币数量
       /*"alloc": {
       “0x0000000000000000000000000000000000000001”:{"balance":"10000000"},
       "0x0000000000000000000000000000000000000002":{"balance":"20000000"}
       },*/
       "alloc"      : {},
       //运行geth 后创建新账户时，如果geth发现没有地址，会默认将第一个账号地址作为矿工账号
       "coinbase"   : "0x0000000000000000000000000000000000000000",
       //挖矿难度
       "difficulty" : "0x02000000",
       //任意填写的附加信息
       "extraData"  : "0x00",
       //gas 最高限制，以太坊运行交易、合约等消耗的gas的最高值
       "gasLimit"   : "0x2fefd8",
       //64位随机数，用于挖矿，
       "nonce"      : "0x0000000000000042",
       //与nonce 共同用于挖矿
       "mixhash"    : "0x0000000000000000000000000000000000000000000000000000000000000000",
       "parentHash" : "0x0000000000000000000000000000000000000000000000000000000000000000",
       //创世块的时间戳
       "timestamp"  : "0x00"
   }
   ```

   在配置genesis.json的时候会出现一些问题，以上的json文件版本适用于1.8.2（我是用的版本），配置时遇到的错误如下：

   * Fatal: invalid genesis file: missing 0x prefix for hex data：这个错误的意思就是，在json文件中，对于16进制的数据，需要加上0x前缀
   * Fatal: invalid genesis file: hex string has odd length：从v1.6开始，设置的十六进制数，不能是奇数位，比如不能是0x0，而应该是0x00
   * Fatal: failed to write genesis block: genesis has no chain configuration ：这个错误的意思是，在json文件中缺少 config 部分
   * Error: invalid sender undefined：这个错误不会导致初始化失败，但是会在以后的转账，或者部署智能合约的时候产生，。解决方法就是chainId不能设置为0

3. 准备好创世区块json配置文件后，需要初始化区块链，将上面的创世区块信息写入到区块链中。首先要新建一个目录mydata用来存放区块链数据（这个mydata目录就相当于一个根节点。当我们基于genesis.json生成根节点后，其他人就可以来连接此根节点，从而能进行交易）。我们在geth的安装目录下创建mydata目录，执行如下初始化命令：

   ```shell
   geth --datadir mydata init genesis.json
   ```

   上面这个命令的主体是geth init，表示初始化区块链，命令可以带有选项和参数，其中--datadir选项后面跟着一个目录，这里为mydata，表示指定数据存放目录为mydata，genesis.json是init命令的参数。

   还可以采用如下方式指定目录

   ```shell
   geth --datadir "%cd%\mydata" init genesis.json
   //%cd%代表geth的安装目录
   ```

   运行上面的命令，会读取genesis.json文件，根据其中的内容，将创世区块写入到区块链中。其中，在mydata目录下，geth/chaindata中存放的是区块数据，keystore存放的是账户数据

4. 启动私有链接点（打开geth控制台）

   ```shell
   geth --datadir mydata --networkid 1108 console
   ```

   上面命令的主体是geth console，表示启动节点并进入交互式控制台，--datadir选项指定选用data0作为数据目录，--networkid选项后面跟一个数字，表示指定这个私有链的网络id，这里为1108。网络id在连接到其他节点的时候会用到，以太坊公网的网络id为1。我们指定的id不能与公网的id重复。

   运行上面的命令后，就启动了区块链节点进入了console，在这个环境里内置了一些用来操作以太坊的对象，这些对象包括：

   * **eth**：包含一些根操作区块链相关的方法
   * **net**：包含一些查看p2p网络状态的方法
   * **admin**：包含一些与管理节点相关的方法
   * **miner**：包含启动/停止挖矿的一些方法
   * **personal**：包含一些管理账户的方法
   * **txpool**：包含一些查看交易内存池的方法
   * **web3**：包含了以上对象，还包含一些单位换算的方法

5. 创建账户

   刚搭建完私有链过后，并没有自己的账户，此时应该输入以下指令来创建账户（我们在此创建两个账户）：

   ```shell
   > personal.newAccount()
   "0x75240812c092f382b75c0475ff0b40d6c3c59f20"
   > personal.newAccount()
   "0x2b9a945bf5e1bfb06227abb1ca37905aa57f6728"
   ```

   返回的是账户的公钥，也就是地址，转账时就需要这个地址。账户默认会保存在数据目录的keystore文件夹中

   可用`eth.accounts`来列出所有账户

6. 查看账户余额

   ```shell
   > eth.getBalance(eth.accounts[0])
   0
   > eth.getBalance(eth.accounts[1])
   0
   ```

   目前两个账户余额均为0

7. 挖矿

   ```shell
   miner.start(10)
   开启挖矿，其中start的参数表示挖矿使用的线程数。
   miner.stop()
   停止挖矿
   ```

   挖到区块后会有奖励，挖矿所得的账户会进入矿工的账户，这个账户叫做coinbase，默认情况下coinbase是本地账户中的第一个账户：

   ```shell
   > eth.coinbase
   INFO [03-16|22:40:06.424] Etherbase automatically configured       address=0x75240812c092f382b7
   5C0475Ff0B40D6c3C59f20
   "0x75240812c092f382b75c0475ff0b40d6c3c59f20"
   ```

   要想使挖矿奖励进入其他账户，通过`miner.setEtherbase(eth.accounts[1])`将其他账户设置成coinbase

   挖到区块后，账户0就有以太币了

   ```shell
   > miner.start(10)
   ...
   > miner.stop()
   null
   > eth.getBalance(eth.accounts[0])
   5000000000000000000（单位是wei）
   ```

8. 发送交易

   ```shell
   > web3.fromWei(eth.getBalance(eth.accounts[0]), 'ether')
   5
   > amount=web3.toWei(2,'ether')
   "2000000000000000000"
   > eth.sendTransaction({from:eth.accounts[0],to:eth.accounts[1],value:amount})
   Error: authentication needed: password or unlock
       at web3.js:3143:20
       at web3.js:6347:15
       at web3.js:5081:36
       at <anonymous>:1:1
   ```

   出现错误的原因是账户每隔一段时间就会被锁上，要发送交易，必须先解锁账户，由于我们从账户0发送交易，所以我们解锁账户0

   ```shell
   > personal.unlockAccount(eth.accounts[0])
   Unlock account 0x75240812c092f382b75c0475ff0b40d6c3c59f20
   Passphrase:
   true
   ```

   再发送交易

   ```shell
   > eth.sendTransaction({from:eth.accounts[0],to:eth.accounts[1],value:amount})
   ...
   "0x16e10270949adb6d47d9822985f24aa7c11bd4deafeb8a8358aacf0556bba647"
   ```

9. 查看当前链上的交易状态

   ```shell
   > txpool.status
   {
     pending: 1,#表示已提交但未被处理的交易
     queued: 0
   }
   ```

   要使交易被处理，必须要挖矿。

   ```shell
   > miner.start(10)
   ...
   > miner.stop()
   null
   > txpool.status
   {
     pending: 0,
     queued: 0
   }
   ```

   此时查看账户1上的余额，发现不为0

   ```
   > eth.getBalance(eth.accounts[1])
   2000000000000000000
   ```

10. 输入exit退出geth控制台，然后输入以下命令启动rpc通信，这样可以进行智能合约的部署和调试

    ```shell
    E:\Geth\geth-1.8.27>geth --rpc --rpcaddr "127.0.0.1" --rpcport "8101" -port "30303" -rpcapi "eth,web3,personal"
    ```

    如果不在此指定当前区块链数据存储位置，那我们之前创建的区块链是没有用上的， 用web3j来查看账户余额为0

    ```java
    public class testweb3j {
        private static final String RPC_URL = "http://127.0.0.1:8101";
        private static final Web3j web3j = Web3j.build(new HttpService(RPC_URL));
    
        public static void main(String[] args) throws IOException {
            getAge();
        }
        public static void getAge() throws IOException {
    
            DefaultBlockParameter defaultBlockParameter = new DefaultBlockParameterNumber(web3j.ethBlockNumber().send().getBlockNumber());
            EthGetBalance ethGetBalance = web3j.ethGetBalance("0x75240812c092f382b75c0475ff0b40d6c3c59f20",defaultBlockParameter).send();
            if (ethGetBalance != null) {
                System.out.println(ethGetBalance.getBalance());
            }
        }
    }
    
    ```

    我们需要指定数据存放位置为之前创建区块链所指定的位置

    ```shell
    E:\Geth\geth-1.8.27>geth --targetgaslimit 4294967295 --rpc --rpcaddr "127.0.0.1" --rpcport "8103" --port "30301" --rpcapi "eth,web3,personal" --networkid 2020 --identity 2020 --nodiscover --maxpeers 5 --datadir "%cd%\mydata" --unlock 0 --rpccorsdomain "*" --mine console
    ```

    targetgaslimit –每个块的gas上限，这里可以暂时理解为容量 

    rpc –启动 rpc 通信，可以进行智能合约的部署和调试 

    rpcaddr – rpc接口的地址 

    rpcport –rpc接口的端口号

    port –网络监听端口，用于节点之间通信 

    rpcapi –设置rpc的范围，暂时开启eth,web3,personal足够 

    networkid –设置当前区块链的网络ID，是一个数字，可以随便写 

    identity –区块链的标示，随便填写，用于标示目前网络的名字 

    nodiscover 禁止被网络中其它节点发现，需要手动添加该节点到网络 

    maxpeers 最大节点数量 

    datadir –设置当前区块链网络数据存放的位置 

    unlock –解锁某用户（此处用用户坐标来控制，解锁后的用户调用接口发起交易时，不要需要提供密码） 

    rpccorsdomain 限制 rpc访问源的 ip，“*” 代表不限制 

    mine 允许挖矿 

    console –启动命令行模式，可以在Geth中执行命令