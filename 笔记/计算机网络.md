# 应用层协议

## DHCP协议

DHCP协议即Dynamic Host Configuration Protocol（动态主机配置协议）的简称。它可以为客户机自动分配IP地址，子网掩码，缺省网关以及DNS服务器的IP地址等TCP/IP参数。

### 主机IP地址的设置

每一台主机的IP地址可以通过以下两种方法来设置：

1. 手动输入
2. 自动向DHCP服务器申请，用户的计算机会自动向DHCP服务器申请IP地址，接收到此请求的DHCP服务器会分配IP地址给用户的计算机。他可以减轻管理负担，避免因手动输入错误而造成的困扰

服务端在主机一般使用手动输入，而客户端主机使用DHCP来动态分配，原因如下:

1. 客户端主机比服务端主机移动更频繁
2. 服务主机需要提供更可靠的服务，其配置信息应该减少对其他系统/主机的依赖
3. 客户主机比服务主机的数量多

**DHCP协议基于UDP传输，服务端端口号为67，客户端端口号为68**

### DHCP的工作流程

1. 寻找服务器

    当DHCP客户端**第一次登陆**网络的时候或者是开机的时候，此设备发现本机上没有任何IP设定，就会**网络广播去寻找DHCP服务器**。由于客户端此时还不知道自己属于哪一个网络，所以封包的来源地址为0.0.0.0，目的地址则为255.255.255.255，然后再附上DHCP discover的信息，像网络广播。**网络上每一台安装了TCP/IP协议的主机都会接收到这个广播信息，但只有DHCP服务器才会响应**

2. 分配IP地址

    当DHCP服务器监听到客户端发出的DHCP discover广播后，会针对这个**客户端的硬件地址**与本身的设定数据来进行下列工作：

    - **到服务器的==登陆文件==中寻找该用户之前是否曾用过某个IP（以客户端的MAC地址为依据），若有且IP目前无人使用，则提供此IP给客户机**
    - 若配置文件针对该MAC提供额外的固定IP时，则提供该固定IP给客户机
    - 若不符合上述条件，则随机取用目前没有被使用的IP参数给客户端，并记录下来。回应给客户端一个DHCP offer封包，由于客户端在开始的时候还没有IP地址，所以在其DHCP discover封包内会带有其MAC地址信息，并且有一个XID来辨别该封包，DHCP服务器回应的DHCP offer封包则会根据这些资料传递给要求租约的客户。根据服务端的设定，DHCP offer封包会包含一个**租约期限**的信息。但**这里仅仅是分配，客户端还没有真正的使用**

3. 请求使用

    如果客户端收到网络上多台DHCP服务器的回应，只会挑选其中一个DHCP offer并且会向网络发送一个DHCP request广播封包，告诉所有DHCP服务器它将指定接受哪一台服务器提供的ip地址。之所以要广播是为了通知所有的DHCP服务器，他将选择某台DHCP服务器所提供的ip地址，同时，客户端还会发送一个ARP封包，查询网络上有没有其他机器使用该IP地址，如果发现该IP被占用，客户端会发送一个DHCP decline封包给DHCP服务器，拒绝接受其DHCP offer，并重新开始发送DHCP discover

4. IP地址分配确认

    **当DHCP服务器收到DHCP客户机回答的DHCP request请求信息之后，它便向DHCP客户机发送一个包含它所提供的IP地址和其他设置的DHCP ack确认信息。以确认IP地址的正式生效。然后DHCP客户机便将其TCP/IP协议与网卡绑定**，另外，除DHCP客户机选中的服务器外，其他的DHCP服务器都收回曾提供的IP地址

### 重新登陆

当DHCP客户机分配到IP后，每次当DHCP客户机重新登录登录时， 则不需要发送DHCP Discover信息了，而是直接发送包含前一次所分配的IP地址的DHCP Request请求信息。当DHCP服务器收到这一信息后， 它会尝试DHCP客户机继续使用原来的IP地址， 并回答一个DHCP Ack确认信息。 如果此IP地址无法继续再分配给原来的DHCP客户机使用时(比如此IP地址已分配给其他DHCP客户机)，则DHCP服务器给DHCP客户机回答一个DHCP NAck否认信息。 当原来的DHCP客户机收到此DHCP NAck否认信息后， 它必须重新发送DHCP Discover信息来重新请求信的IP地址

### 更新租约

DHCP服务器向DHCP客户机出租的IP地址一般都有一个租借期限， 期满后DHCP服务器便会收回出租的IP地址，如果DHCP客户机要延长其IP租约， 则必须更新其IP租约。DHCP客户机启动时和IP租约期限过一半时， DHCP客户机都会自动向DHCP服务器发送其IP租约的信息。 DHCP客户机除了在开机的时候发出DHCP Request请求外， 在使用租期超过50%时刻处，DHCP 客户机会以**单播**形式向DHCP Server发送DHCP Request报文来续租IP地址。如果DHCP 客户机成功收到DHCP 服务器发送的DHCP ACK报文，则按相应时间延长IP地址租期；如果没有收到DHCP 服务器发送的DHCP ACK报文，则DHCP 客户机继续使用这个IP地址。在使用租期超过87.5%时刻处，DHCP 客户机会以广播形式向DHCP Server发送DHCP Request报文来续租IP地址。如果DHCP 客户机成功收到DHCP 服务器发送的DHCP ACK报文，则按相应时间延长IP地址租期；如果没有收到DHCP 服务器发送的DHCP ACK报文，则DHCP 客户机继续使用这个IP地址，直到IP地址使用租期到期时，DHCP Client才会向DHCP Server发送DHCP Release报文来释放这个IP地址。 客户端想提前退租， 可以随时发送DHCP Release命令解约

## DNS协议

**域名服务主要是基于UDP实现的，服务器的端口号为53**

### 域名解析过程

1. 查看浏览器的缓存中是否有对应的结果
2. 查看本机中是否有对应的结果
3. 主机向本地域名服务器进行递归查询
4. 本地域名服务器采用迭代查询，向一个根域名服务器进行查询
5. 根域名服务器告诉本地域名服务器，下一次应该查询的顶级域名服务器的IP地址
6. 本地域名服务器向顶级域名服务器进行查询
7. 顶级域名服务器告诉本地域名服务器，下一步查询权限域名服务器的IP地址
8. 本地域名服务器向权限域名服务器进行查询
9. 权限服务器告诉本地域名服务器所查询的主机的IP地址
10. 本地域名服务器最后把查询结果告诉主机

## CDN的原理

1. CDN的工作流程

    CDN的工作流程与DNS解析相关，它只是在DNS解析流程中加入了智能DNS（调度DNS）这一步骤，**当客户发出网络请求时，智能DNS服务器会根据IP地址判断出地理位置，然后返回最近距离的服务器的IP地址，而不是直接返回源站IP**

    ![image-20200810213217380](F:\java书和视频\笔记\images\面经\36.png)

如图所示是通过CDN进行请求响应的过程图。通过图中可以看出，在DNS解析域名时新增了一个`全局负载均衡系统（GSLB）`，GSLB的主要功能是**根据用户的本地DNS的IP地址判断用户的位置**，**筛选出距离用户较近的`本地负载均衡系统（SLB）`，并将该SLB的IP地址作为结果返回给本地DNS**。SLB主要负责判断`缓存服务器集群`中是否包含用户请求的资源数据，如果缓存服务器中存在请求的资源，则根据缓存服务器集群中节点的健康程度、负载量、连接数等因素筛选出最优的缓存节点，并将HTTP请求重定向到最优的缓存节点上。

1. 用户发起对"join.qq.com/video.php"的HTTP请求，首先需要通过本地DNS通过"迭代解析"的方式获取域名"join.qq.com"的IP地址；

2.  如果本地DNS的缓存中没有该域名的记录，则向`根DNS`发送DNS查询报文；

3. `根DNS`发现域名的前缀为"com"，则给出负责解析`com`的`顶级DNS`的IP地址；

4. 本地DNS向`顶级DNS`发送DNS查询报文；

5. `顶级DNS`发现域名的前缀为"qq.com"，在本地记录中查找负责该前缀的`权威DNS`的IP地址并进行回复；

6. 本地DNS向`权威DNS`发送DNS查询报文；

7. 权威DNS查找到一条NAME字段为"join.qq.com"的`CNAME记录`（由服务提供者配置），该记录的Value字段为"join.qq.cdn.com"；并且还找到另一条NAME字段为"join.qq.cdn.com"的A记录，该记录的Value字段为GSLB的IP地址；

8. 本地DNS向GSLB发送DNS查询报文；

9. GSLB根据`本地DNS`的IP地址判断用户的大致位置为深圳，筛选出位于华南地区且综合考量最优的SLB的IP地址填入DNS回应报文，作为DNS查询的最终结果；

10. 本地DNS回复客户端的DNS请求，将上一步的IP地址作为最终结果回复给客户端；

11. 客户端根据IP地址向SLB发送HTTP请求："[join.qq.com/video.php](https://join.qq.com/video.php)"；

12. SLB综合考虑缓存服务器集群中各个节点的资源限制条件、健康度、负载情况等因素，筛选出最优的缓存节点后回应客户端的HTTP请求（状态码为302，重定向地址为最优缓存节点的IP地址）；

13. 客户端接收到SLB的HTTP回复后，重定向到该缓存节点上；

14. 缓存节点判断请求的资源是否存在、过期，将缓存的资源直接回复给客户端，否则到源站进行数据更新再回复。



链接：https://juejin.im/post/6844903873518239752

1. CDN的好处
    - 用户与服务端物理距离变短，加快了网站的响应速度
    - 减轻了服务器的负载，带宽等压力，服务器的效率也会变得更高
    - 原站变得更加隐蔽，更加安全

## TCP三次握手

### 三次握手的第三次握手发送ack能携带数据吗？

可以携带数据，因为此时客户端已经处于established状态了